## Описание работы системы

Система - интерпретатор командной строки **CLI**, который поддерживает выполнение втсроенных
команд (`cat`, `echo`, `wc`, `pwd`, `exit`, `grep`) и вызов внешних программ.
Каждая команда, которая вводится пользователем,
разбирается на составные части с учетом аргументов, кавычек и переменных окружения. Если введенная команда соответствует
одной из встроенных, она выполняется напрямую. Иначе она передается для выполнения внешнему процессу.
Система поддерживает задание и использование переменных окружения, которые могут быть подставлены в команды. Также
реализована возможность объединения команд с помощью пайплайнов, что позволяет передавать вывод одной команды на вход
следующей.

### Основные компоненты системы

**Main**– главный класс приложения. Запускает цикл обработки пользовательского ввода, передает команды в парсер, а затем
выполняет их через исполнитель executor или pipeline.

**Parser** – отвечает за разбор пользовательского ввода. Обрабатывает кавычки - одинарные и двойные, разделители,
подстановку переменных
окружения и формирует команды для выполнения - объекты Command.

**Command** – представляет собой структуру, содержащую информацию о команде - её названии и списке аргументов.

**Executor** – выполняет команды. Для встроенных команд вызывает соответствующие
обработчики (`executeEcho`, `executeCat`, `executeWc`, `executePwd`), а для внешних использует ProcessBuilder.

**Environment** – управляет переменными окружения, хранит их в `HashMap<String, String>`. Позволяет устанавливать,
изменять и подставлять значения переменных в
команды.

**Pipeline** – отвечает за обработку пайплайнов - последовательности команд, соединенных оператором `|`. Связывает
команды через потоки ввода-вывода и выполняет команды последовательно, передавая вывод одной команды на вход следующей.

**GrepHandler** – обрабатывает команду `grep` с поддержкой регулярных выражений. Реализует поиск по файлу или входному
потоку с учетом флагов:

- i (регистронезависимый поиск)

- w (поиск целых слов)

- A NUM (вывод N строк после совпадения)

**GrepParameters** – хранит параметры для команды `grep`, включая шаблон поиска и флаги. Использует `JCommander` для парсинга
аргументов командной строки.

На [структурной диаграмме](se-hw-diagram.jpg) показана связь между основными классами системы: Main, Parser, Command,
Executor, Environment, Pipeline, а также их взаимодействие при обработке команд в процессе выполнения.

### Поток выполнения

1. Пользователь вводит команду. Если команда `exit` или EOF, программа завершает работу.
2. Далее парсер разбирает строку на токены, обрабатывает кавычки и подставляет переменные окружения.
3. Создается объект `Command` для каждой команды. Если команда одна, она передается в `Executor`. Если команды соединены
   оператором `|`, они передаются в `Pipeline` - он связывает команды через потоки ввода-вывода и выполняет их
   последовательно.
4. Если команда встроенная, она выполняется напрямую через соответсвующие обработчики команд в `Executor`. Если
   внешняя - запускается через ProccessBuilder.
5. Результат выводится на экран. Если команда не найдена или произошла ошибка, выводится сообщение об ошибке с
   соответсвующим кодом возврата.

### Детали реализации

- **Парсинг**:
    - Подставляются значения переменных окружения вида `$VAR` - если такой переменной в `Environment` нет, то по
      умолчанию подставляется `""`.
    - Ввод пользоваетля разбивается на части, учитывая аргументы в кавычках, с помощью регулярных
      выражений `Pattern.compile("\"([^\"]*)\"|'([^']*)'|(\\S+)")`.
    - Если в строке есть `|`, парсер разбивает ввод на несколько команд - создает несколько объектов `Command` и
      передает их
      в `Pipeline`.
    - Подстановка переменных окружения выполняется до токенизации, перед созданием Command объекта. Например, при
      вводе `echo "Hello, $USER"` будет `echo "Hello, username"`, и токены: `["echo", "Hello, username"]`
- **Переменные окружения**: Хранятся в `Environment` в `HashMap<String, String>`
- **Код возврата**: Для внешних команд возвращается код завершения процесса с помощью `Process.waitFor()`.
- **Класс `Command`** содержит:
    - `name`: Имя команды (например, `cat`).
    - `arguments`: Список аргументов (например, `["file.txt"]`).
- **Пайплайн**: `ProcessBuilder` связывает стандартный вывод одной команды со стандартным вводом следующей. Потоки
  управляются через `Process.getInputStream()` и `Process.getOutputStream()`. Если любая команда завершилась с ошибкой (
  код возврата != 0), пайплайн должен прекратить выполнение с итоговым кодом возврата = коду последней выполненной
  команды. Если все команды выполнились без ошибок, то итоговый код возврата - код последней команды.
- Для реализации парсинга аргументов команды grep была выбрана библиотека `JCommander`. Альтернативно рассматривались `Apache Commons CLI`, `Argparse4j`.

    Почему вырана именно `JCommander`?
    - Лаконичный синтаксис на аннотациях. При использовании `Apache Commons CLI` много шаблонного кода, без аннотаций, а в `Argparse4j` синтаксис сложнее, чем в выбранной библиотеке.
    - Автоматическая конвертация типов, а в `Apache Commons CLI` ручная обработка типов
    - Поддержка Unicode
    - Гибкость — поддерживает короткие (`-i`), длинные (`--ignore-case`) и комбинированные (`-iwA 5`) флаги.
    
    `Argparse4j` избыточна для данного проекта, поэтому `JCommander` оказался оптимальным выбором по соотношению простоты и функциональности.
